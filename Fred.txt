SELECT
    'IF EXISTS (SELECT 1 FROM CalculatedRateDefinitions WHERE ShortName = ''' + TempR.shortname + ''') ' +
    'BEGIN ' +
    'IF NOT EXISTS (SELECT 1 FROM [BSDRate].[dbo].[CalculatedRateCategories] ' +
    'WHERE CalculatedRateID = (SELECT CalculatedRateDefinitions.CalculatedRateID FROM CalculatedRateDefinitions WHERE CalculatedRateDefinitions.ShortName = ''' + TempR.shortname + ''') ' +
    'AND CategoryID = ' + ISNULL(CAST(CalculatedRateCategories.[CategoryID] AS VARCHAR), '0') + ') ' +
    'BEGIN ' +
    'INSERT INTO [BSDRate].[dbo].[CalculatedRateCategories] ([CalculatedRateID], [CategoryID]) ' +
    'SELECT (SELECT CalculatedRateDefinitions.CalculatedRateID FROM CalculatedRateDefinitions WHERE CalculatedRateDefinitions.ShortName = '''
    + TempR.shortname + '''), ' + ISNULL(CAST(CalculatedRateCategories.[CategoryID] AS VARCHAR), '0') +
    ' END ' +
    'END'
FROM CalculatedRateCategories
INNER JOIN CalculatedRateDefinitions
    ON CalculatedRateCategories.CalculatedRateID = CalculatedRateDefinitions.CalculatedRateID
INNER JOIN @tempRateNames TempR
    ON TempR.shortname = CalculatedRateDefinitions.ShortName;
