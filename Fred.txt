WITH MaxImportDates AS (
    SELECT
         CT.ContractorMasterID,
         MAX(CT.RecordID) AS RecordID
    FROM
        Contractors.[VMSContractorListHistory] CT
    WHERE
        CT.ContractorMasterID IS NOT NULL
    GROUP BY
        ContractorMasterID
),
ContractorDetails AS (
    SELECT   
        LTRIM(RTRIM(WL.MailLocationCD)) AS MailLocationCD
        ,WL.LongDESC AS LongDESC
        ,WL.AddressLine1 AS AddressLine1
        ,WL.AddressLine2 AS AddressLine2
        ,WL.City AS City
        ,WL.StateCD AS StateCD
        ,ZipCode.ZipCD AS ZipCD
        ,CASE
            WHEN Country.CountryCD3 IS NULL THEN Country.CountryCD
            ELSE Country.CountryCD3
         END AS CountryCD
        ,Country.CountryNM
        ,CAST(BWI.StartDate AS Datetime) AS HireDT
        ,EM.AssignmentLaborCategoryCode
        ,EM.AssignmentLaborCategoryName
        ,EM.SupplierName
        ,EM.SupplierCode
        ,EM.OnshoreOffshore
        ,BWI.RecordID
        ,BWI.ImportDateTime
        ,BWI.ContractorMasterID
        ,BWI.CurrentStatus
        ,BWI.VMSSourceKey
        ,BWI.AssignmentID
        ,BWI.RequestID
        ,BWI.FirstName
        ,BWI.MiddleName
        ,BWI.LastName
        ,BWI.TransactionDate
        ,BWI.EffectiveDate
        ,BWI.StartDate
        ,BWI.EndDate
        ,BWI.TerminationDate
        ,CASE
            WHEN BWI.PreferredID IS NULL OR RTRIM(LTRIM(BWI.PreferredID)) = '' THEN AD.PreferredID
            ELSE BWI.PreferredID
         END AS PreferredID
        ,BWI.ManagerPreferredID
        ,BWI.JobTitleCode
        ,BWI.SystemAccess
        ,BWI.InfoSecIgnoreRecord
        ,BWI.MailLocationCode
        ,BWI.MailCodeOverride
        ,BWI.TimeKeepingSendToVMS
    FROM
        MaxImportDates MID
    INNER JOIN
        Contractors.[VMSContractorListHistory] BWI
        ON MID.ContractorMasterID = BWI.ContractorMasterID AND
           MID.RecordID = BWI.RecordID
    INNER JOIN
        Contractors.EngagementsMaster EM ON EM.ContractorMasterID = BWI.ContractorMasterID
    LEFT JOIN
        dbo.MailLocation WL ON WL.MailLocationCD = BWI.MailLocationCode
    INNER JOIN
        dbo.ZipCode ON ZipCode.ZipCodeID = WL.ZipCodeID
    LEFT JOIN
        dbo.Country ON Country.CountryCD = WL.CountryCD
    LEFT JOIN
        dbo.AD_Person_LOAD AD ON AD.employeeID = BWI.ContractorMasterID
    WHERE
        BWI.PreferredID IS NOT NULL
        AND BWI.PreferredID <> ''
),
RankedRecords AS (
    SELECT
        CD.*,
        ROW_NUMBER() OVER (PARTITION BY CD.PreferredID ORDER BY CD.RecordID DESC) AS RN
    FROM
        ContractorDetails CD
)

SELECT *
FROM
    RankedRecords
WHERE
    RN = 1;
