using System;
using System.IO;
using System.Threading.Tasks;
using Microsoft.Graph;
using Microsoft.Graph.Models;
using Azure.Identity;

namespace GraphProfileImage
{
    class Program
    {
        private const string tenantId = "YOUR_TENANT_ID";
        private const string clientId = "YOUR_APPLICATION_ID";
        private const string clientSecret = "YOUR_CLIENT_SECRET";
        private const string userEmail = "USER_EMAIL"; // Replace with the user's email address

        static async Task Main(string[] args)
        {
            var graphClient = GetAuthenticatedGraphClient();
            var user = await GetUserByEmailAsync(graphClient, userEmail);

            if (user != null)
            {
                var photoStream = await graphClient.Users[user.Id].Photo.Content.GetAsync();

                using (var fileStream = new FileStream("profileImage.jpg", FileMode.Create, FileAccess.Write))
                {
                    await photoStream.CopyToAsync(fileStream);
                }

                Console.WriteLine("Profile image saved successfully.");
            }
            else
            {
                Console.WriteLine("User not found.");
            }
        }

        private static GraphServiceClient GetAuthenticatedGraphClient()
        {
            var clientSecretCredential = new ClientSecretCredential(tenantId, clientId, clientSecret);

            return new GraphServiceClient(clientSecretCredential, new[] { "https://graph.microsoft.com/.default" });
        }

        private static async Task<User> GetUserByEmailAsync(GraphServiceClient graphClient, string email)
        {
            var users = await graphClient.Users
                .GetAsync(requestConfiguration =>
                {
                    requestConfiguration.QueryParameters.Filter = $"userPrincipalName eq '{email}'";
                });

            if (users.Value.Count > 0)
            {
                Console.WriteLine($"Found {users.Value.Count} user(s) with email '{email}':");
                foreach (var user in users.Value)
                {
                    Console.WriteLine($"- {user.DisplayName} ({user.Id})");
                }

                // Return the first user that matches the email exactly
                return users.Value.FirstOrDefault(u => u.UserPrincipalName.Equals(email, StringComparison.OrdinalIgnoreCase));
            }

            Console.WriteLine($"No users found with email '{email}'");
            return null;
        }
    }
}
